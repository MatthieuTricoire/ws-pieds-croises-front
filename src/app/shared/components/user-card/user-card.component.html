<div
  class="bg-base-100 rounded-xl px-4 md:px-15 py-4 md:py-6 w-full shadow-lg flex flex-col md:flex-row md:items-center md:justify-between"
>
  <!-- Avatar -->
  <div class="avatar-container absolute left-1/2 -top-16 md:-top-16 -translate-x-1/2">
    @if (profilePictureUrl) {
      <div class="avatar relative p-4">
        <div
          class="rounded-full border-[4px] border-primary overflow-hidden w-32 h-32 md:w-40 md:h-40 shadow-lg"
        >
          <img
            alt="Photo de {{ user()?.firstname }}"
            class="w-full h-full object-cover"
            src="{{ profilePictureUrl }}"
          />
        </div>

        <!-- Bouton crayon -->
        <button
          type="button"
          (click)="fileInput.click()"
          class="absolute bottom-7 right-3 bg-white rounded-full p-2 shadow hover:scale-110 transition border-[2px] border-primary hover:border-success"
        >
          <lucide-angular [img]="SquarePen" class="w-4 h-4 text-base-100" />
        </button>
        <!-- Bouton delete -->
        <button
          type="button"
          (click)="openDeleteModal()"
          class="absolute bottom-14 right-1 bg-white rounded-full p-2 shadow hover:scale-110 transition border-[2px] border-primary hover:border-error"
        >
          <lucide-angular [img]="Trash" class="w-3 h-3 text-base-100" />
        </button>

        <!-- Modal de confirmation -->
        <dialog #deleteModal class="modal modal-bottom sm:modal-middle">
          <div class="modal-box">
            <h3 class="text-lg font-bold">Confirmer la suppression</h3>
            <p class="py-4">Êtes-vous sûr de vouloir supprimer votre photo de profil ?</p>
            <div class="modal-action">
              <button class="btn" (click)="deleteModal.close()">Annuler</button>
              <button class="btn btn-error" (click)="confirmDelete()">Supprimer</button>
            </div>
          </div>
        </dialog>
      </div>
    } @else {
      <div class="avatar avatar-placeholder relative p-4">
        <div
          class="bg-primary text-neutral-content rounded-full border-[4px] border-primary overflow-hidden w-32 h-32 md:w-40 md:h-40 shadow-lg flex items-center justify-center"
        >
          <span class="text-xl md:text-3xl">{{ getUserInitials() }}</span>
        </div>

        <!-- Bouton crayon (si pas encore de photo) -->
        <button
          type="button"
          (click)="fileInput.click()"
          class="absolute bottom-7 right-3 bg-white rounded-full p-2 shadow hover:scale-110 transition"
        >
          <lucide-angular [img]="SquarePen" class="w-5 h-5 text-base-100" />
        </button>
      </div>
      <!-- Message d'erreur -->
      @if (errorMessage) {
        <div class="text-red-500 text-sm mt-2 text-center">
          {{ errorMessage }}
        </div>
      }
    }

    <!-- Input fichier caché -->
    <input
      #fileInput
      (change)="onFileSelected($event)"
      accept="image/png, image/jpeg"
      class="hidden"
      type="file"
    />
  </div>

  <!-- Infos gauche -->
  <div
    class="flex flex-col gap-1 lg:gap-2 items-center md:items-start mt-16 md:mt-0 w-full md:w-auto"
  >
    <button
      (click)="startEditing()"
      class="absolute top-5 left-8 md:static md:self-start hover:scale-110 transition"
    >
      <lucide-angular [img]="UserPen" class="w-5 h-5 mb-2 text-white" size="20px" />
    </button>

    @if (isEditing()) {
      <form
        [formGroup]="profileForm"
        (ngSubmit)="saveChanges()"
        class="flex flex-col gap-2 w-full max-w-xs"
      >
        <input
          type="text"
          formControlName="firstname"
          class="input input-bordered w-full"
          placeholder="Prénom"
        />
        @if (profileForm.get('firstname')?.errors?.['message']) {
          <div class="text-red-500 text-sm">
            {{ profileForm.get('firstname')?.errors?.['message'] }}
          </div>
        }

        <input
          type="text"
          formControlName="lastname"
          class="input input-bordered w-full"
          placeholder="Nom"
        />
        @if (profileForm.get('lastname')?.errors?.['message']) {
          <div class="text-red-500 text-sm">
            {{ profileForm.get('lastname')?.errors?.['message'] }}
          </div>
        }

        <input
          type="text"
          formControlName="phone"
          class="input input-bordered w-full"
          placeholder="Téléphone"
        />
        @if (profileForm.get('phone')?.errors?.['message']) {
          <div class="text-red-500 text-sm">
            {{ profileForm.get('phone')?.errors?.['message'] }}
          </div>
        }

        <button type="submit" class="btn btn-primary w-full mt-2" [disabled]="isSaving()">
          @if (isSaving()) {
            <span class="loading loading-spinner"></span> Sauvegarde...
          } @else {
            Sauvegarder
          }
        </button>
        <button type="button" class="btn btn-ghost w-full" (click)="isEditing.set(false)">
          Annuler
        </button>
      </form>
    } @else {
      <app-typography [text]="userName" tagType="h3" className="text-center md:text-left" />
      <p class="text-center md:text-left">{{ user()?.email }}</p>
      <p class="text-center md:text-left">{{ user()?.phone }}</p>
    }
  </div>

  <!-- Infos droite -->
  <div class="grid grid-cols-2 gap-y-2 mt-6 md:mt-0">
    @if (userSubscriptionSignal()) {
      <span class="text-left md:text-left">Abonnement&nbsp;:</span>
      <div class="ml-2 badge badge-outline badge-primary px-2 py-0.5 whitespace-nowrap">
        {{ userSubscriptionSignal()?.subscription?.name }}
      </div>

      <span class="text-left md:text-left">Fin&nbsp;:</span>
      <span class="font-semibold ml-2">{{
        userSubscriptionSignal()?.endDate | date: 'dd MMMM'
      }}</span>

      <span class="text-left md:text-left">Sessions&nbsp;/ semaine&nbsp;:</span>
      <span class="font-semibold ml-2">
        {{
          userSubscriptionSignal()?.subscription?.sessionPerWeek === 0 ||
          userSubscriptionSignal()?.subscription?.sessionPerWeek === null
            ? 'Illimitées'
            : userSubscriptionSignal()?.subscription?.sessionPerWeek
        }}
      </span>
    }
    <span class="text-left md:text-left">Inscrit depuis le&nbsp;:</span>
    <span class="font-semibold ml-2">{{ user()?.createdAt | date: 'dd MMMM' }}</span>
  </div>
</div>
